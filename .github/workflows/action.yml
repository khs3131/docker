name: Build Nginx Docker Image

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v3

      #- name: í˜„ì¬ ì‹œê°„ í™•ì¸(YYYYMMDD)
      #  id : date
      #   run: echo "TAG=$(date + '%Y%m%dv1')" >> "$GITHUB_OUTPUT"
      
      - name: ğŸ“Œ GitHub íƒœê·¸ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        id: get_version
        run: |
          VERSION_COUNT=$(git ls-remote --tags origin | grep "$(date +'%Y%m%d')" | wc -l)
          TAG_NAME="$(date +'%Y%m%d')v$((VERSION_COUNT + 1))"
          echo "TAG=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ³ Docker ë¹Œë“œ
        run: |
          docker build -t chulbori/nginx-basic:${{ steps.get_version.outputs.TAG }} ./nginx-basic

      - name: ğŸ“¦ Docker ì´ë¯¸ì§€ í™•ì¸
        run: |
          docker images
      
      - name: Show Docker Image Tags
        run: |
          echo "Built Tag: ${{ steps.get_version.outputs.TAG }}"

      - name: Docker HUB ë¡œê·¸ì¸
        run: |
          echo ${{ secrets.DOCKER_HUB_PASSWORD }} | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: ğŸ“¦ Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: |
          docker push chulbori/nginx-basic:${{ steps.get_version.outputs.TAG }}

      
